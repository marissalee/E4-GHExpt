---
title: "E4 manuscript Results - Using base graphics"
author: "Marissa Lee"
date: "September 15, 2014"
output:
  pdf_document: default
  html_document: default
---

*Load libraries*
```{r, message=FALSE}
#library(doBy)
#library(lme4)
# library(coefplot2)# this no longer exists for R version 3.1.1
#library(coefplot)# hopefully this has the same functionality...
#require(data.table)
```

*Import data*
```{r, echo=FALSE}
data<-read.table('e4_trimmedData.txt',header=T)
```

*Modify...*
Create a total aboveground biomass column by adding Microstegium biomass, Panicum biomass, Sorghum biomass per observation (pot). Make sure that block is coded as a factor.  Create 'compabund' (aka Neighbor abundance) column by adding Panicum biomass and Sorghum biomass per observation (pot).
```{r, echo=FALSE}
data$total<-data$Mvabund + data$pavi + data$sobi
data$bk<-as.factor(data$bk)
data$compabund<-data$pavi + data$sobi
```

*Subset...*
Subset data based on whether it is a monoculture or mixture pot, also subset by the species identity (in the case of monocultures) or the neighbor treatment (in the case of the mixtures).
```{r, echo=FALSE}
Empty<-data[data$type=='Empty',]
Mivi<-data[data$type=='Mivi',]
Pavi<-data[data$type=='Pavi',]
Sobi<-data[data$type=='Sobi',]
CompEmpty<-data[data$type=='CompEmpty',]
CompPavi<-data[data$type=='CompPavi',]
CompSobi<-data[data$type=='CompSobi',]
```

__________________________

#1. UNPLANTED AND MONOCULTURE POTS  

*Consolidate relevant data*
```{r, include=FALSE}
datam<-rbind(Empty, Pavi, Sobi, Mivi)
#make a column for monoculture/unplanted categories
datam$plant<-rep(NA,length(datam$type)) #key: 1= Unplanted, 2=M.v., 3= P.v., 4=S.b.
datam[which(datam$type=='Empty'),19]<-1 
datam[which(datam$type=='Mivi'),19]<-2
datam[which(datam$type=='Pavi'),19]<-3
datam[which(datam$type=='Sobi'),19]<-4
#xs
plant<-datam$plant
plantlabels<-c('Unplanted','M.v.','P.v.','S.b.')
bk<-datam$bk
#ys
soilmoi<-datam$soilmoi
nodi<-datam$nodi
nitrifd<-datam$nitrifd
#other
total<-datam$total
tmp<-total; hist(tmp); shapiro.test(tmp) #not normal, but better than log-transformed
compabund<-data$compabund

datamf<-data.frame(total, soilmoi, nodi, nitrifd, plant, bk)
head(datamf)
#write.table(datamf, file='datamf.txt', sep='\t', row.names=F)
```

*Summarize and plot total dry aboveground biomass, soil moisture, nitrate, and nitrification*   
Run the Loop
```{r, echo=FALSE}

#initiate lists
sums<-list()
models<-list()
modelfits<-list()
termeffs<-numeric(0)
lm.pvals<-list()
tukys<-list()

###looped through each panel (soil measurement)
i<-1
resps<-datamf[,c(1:4)]
shortnames<-c('total','soilmoi','nodi','nitrifd')
resp<-resps[,i] #pull out the correct soil measurement column
data<-data.frame(resp,plant,bk) #put it into a simplified df with just bk and the type of monoculture it is (plant)
  
#Part 1 - summarize
dat<-data.table(data) # require(data.table) is needed for this to work

sum<-dat[,list(mean = mean(resp), 
                 se = sd(resp)/sqrt(length(resp)), 
                 n = length(resp)),
         by = plant]
sum1<-orderBy(~plant,sum)
sum1$plant<-plantlabels	
sums[[i]]<-sum1

#Part 2 - lme model
trt<-as.factor(plant)
data1<-data.frame(resp, trt,bk)
model <- lmer(resp ~ trt+(1|bk), data=data1)

#collect model info
##random effects
### Var
REvar<-as.data.frame(VarCorr(model))[,'vcov']
### SD
REsd<-as.data.frame(VarCorr(model))[,'sdcor']
### names of the random effect levels
RElevels<-as.data.frame(VarCorr(model))[,1]

##fixed effects
### Est
FEest<-fixef(model)
### SE
FEsderr <- sqrt(diag(vcov(model))) #std err
### t value
t <- FEest/FEsderr 
### names of the fixed effect levels
FElevels<-names(FEest)

#run the reduced model
modela<- lmer(resp ~ 1+(1|bk), data=data1)

#compare the full and reduced model with ANOVA
termeff<-anova(modela,model)
### delAIC
aic.model<-termeff[2,2] 
aic.modela<-termeff[1,2]
delAIC<-aic.model - aic.modela
### chisq
Chisq<-termeff[2,6]
### pval
anova.pval<-termeff[2,8]
### chisq df
ChisqDF<-termeff[2,7]
### model dfs
df.model<-termeff[1,1]
df.modela<-termeff[2,1]

#Part 2b - lm model and post-hoc tests
#fit lm
lm <- lm(resp ~ trt, data=data1)
lmfit<-aov(lm)

#save the anova pval and tuky pvals
lm.pval<-anova(lmfit)$'Pr(>F)'[1]
tuky<-TukeyHSD(lmfit)$trt
  
```

Check out the results
```{r, include=FALSE}
#Summary datatable
names(sums)<-shortnames
sumsdf<-data.frame(sums)
#write.table(sumsdf, file='summary_monos.txt', sep='\t', row.names=F)

#LME model summary

#LM model summary and posthoc test results



```
*Do the same thing for ammonium, total inorganic N, ammonification, and mineralization* 

#2. MIXED COMMUNITY POTS  

*Consolidate relevant data*
```{r, echo=FALSE}
dataa<-rbind(CompEmpty, CompPavi, CompSobi)
dataa$logtotal<-log(dataa$total)

#make a column for trt (mvtrt x comptrt) - this is needed so that I can summarize within cross categories?
dataa$trt<-rep(NA,length(dataa$comptrt))
for (k in 1:dim(dataa)[1]){ #loop through each row in dataa
  mvname<-dataa[k,4] #make a character string out of mvtrt and comptrt
  compname<-dataa[k,3]
  trtname<-paste(mvname,compname, sep='_')
  dataa[k,20]<-trtname #put that character string into the trt col
}

#xs
logtotal<-dataa$logtotal
mvtrt<-dataa$Mvtrt 
comptrt<-dataa$comptrt
trt<-dataa$trt
bk<-dataa$bk

#make a mvtrt x comptrt column

#ys
soilmoi<-dataa$soilmoi 
nodi<-dataa$nodi
nhno<-dataa$nh.no
nitrifd<-dataa$nitrifd
minzd<-dataa$minzd

#other vars
abund<-dataa$Mvabund
relabund<-dataa$MVrelabund
compabund<-dataa$compabund
nhdi<-dataa$nhdi
totdi<-dataa$totdi
ammonifd<-dataa$ammonifd
total<-dataa$total

#why are there so many datasets?
dataaf<-data.frame(soilmoi, nodi, nitrifd, mvtrt,comptrt,trt,logtotal,bk,abund,relabund, compabund, total)
databf<-data.frame(nhdi, nodi, totdi,mvtrt,comptrt,trt,logtotal,bk,abund,relabund, compabund)
datacf<-data.frame(ammonifd, nitrifd, minzd,mvtrt,comptrt,trt,logtotal,bk,abund,relabund, compabund)
```

*Summarize data for total dry aboveground biomass, soil moisture, nitrate, and nitrification*  
```{r, include=FALSE}
resps<-dataaf[,c(12,1:3)] #loop through these
respnames<-c('Total dry aboveground biomass (g)','Soil moisture (%)','Nitrate (ugN/G)','Net Nitrification (ugN/G*d)')
shortnames<-c('total','soilmoi','nodi','nitrifd')

#put this in a loop that goes through each soil response column, resps
i<-1  
resp<-resps[,i]
  data<-data.frame(resp,mvtrt,comptrt,trt,logtotal,bk)
  
#Part 1 - Summarize data
  dat<-data.table(data) # require(data.table) is needed for this to work
  sum.mvtrt<-dat[,list(mean=mean(resp), se=sd(resp)/sqrt(length(resp)), n=length(resp)),by=mvtrt]
  sum.comptrt<-dat[,list(mean=mean(resp), se=sd(resp)/sqrt(length(resp)), n=length(resp)),by=comptrt]
  sum.trt<-dat[,list(mean=mean(resp), se=sd(resp)/sqrt(length(resp)), n=length(resp)),by=trt]
  
sum.mvtrt1<-orderBy(~mvtrt,sum.mvtrt)
sum.comptrt1<-orderBy(~comptrt,sum.comptrt)
sum.trt1<-orderBy(~trt,sum.trt)
  
  #Part2 - lm model and tukey posthoc tests
#fit full model
lm <- lm(resp ~ mvtrt + comptrt + mvtrt:comptrt, data=data)
lmfit <- aov(lm)

#fit mvtrt only
lm.mvtrt <- lm(resp ~ mvtrt, data=data)
lmfit.mvtrt<-aov(lm.mvtrt)
tuky.mvtrt<-TukeyHSD(lmfit.mvtrt)$`mvtrt`

#fit comptrt only
lm.comptrt <- lm(resp ~ comptrt, data=data)
lmfit.comptrt<-aov(lm.comptrt)
tuky.comptrt<-TukeyHSD(lmfit.comptrt)$comptrt
  
#fit saturated model
lm.trt <- lm(resp ~ trt, data=data)
lmfit.trt<-aov(lm.trt)
tuky.trt<-TukeyHSD(lmfit.trt)$trt
  
respname<-rep(respnames[i],(dim(tuky.mvtrt)[1]+dim(tuky.comptrt)[1]+dim(tuky.trt)[1]))
contrast<-c(rownames(tuky.mvtrt),rownames(tuky.comptrt),rownames(tuky.trt))
tuky<-rbind(tuky.mvtrt,tuky.comptrt,tuky.trt)
lmfit<-cbind(respname,contrast,tuky)

#write.table(sumsdf, file='summary_mixedcomm.txt', sep='\t', row.names=F)
#write.table(tukystab, file='tukys_mixedcomm.txt', sep='\t', row.names=F)
```

*Plot Logtotal vs mvtrt and Logtotal vs neigtrt to evaluate their relationships*
```{r echo=FALSE}
data<-dataaf
logtotal<-dataaf$logtotal
comptrt<-dataaf$comptrt
mvtrt<-dataaf$mvtrt
dat<-data.table(data)

```

*Make more figures*
```{r, echo=FALSE}

resps<-dataaf[,c(1:3)]
respnames<-c('Soil moisture (%)','Nitrate (ugN/G)','Nitrification\n(ugN/G*d)')
shortnames<-c('soilmoi','nodi','nitrifd')
yname1<-'Soil moisture (%)'
yname2<-expression(paste("Nitrate (",mu,"gN/G)"))
yname3<-expression(paste("Nitrification (",mu,"gN/G"%*%"d)"))  
resplabels<-c(yname1,yname2,yname3)

#loop through the soil responses, resps
i<-1
resp<-resps[,i]
  data<-data.frame(resp,mvtrt,comptrt,logtotal,bk)
  data1N<-subset(data, comptrt=='N')
  data1P<-subset(data, comptrt=='P')
  data1S<-subset(data, comptrt=='S')
  
#Model1
#fit mixed effects model, and reduced models
model1<-lmer(resp ~ mvtrt + comptrt + mvtrt:comptrt+(1|bk), data=data)
model1a<-lmer(resp ~ mvtrt + comptrt +(1|bk), data=data)
model1b<-lmer(resp ~ mvtrt +(1|bk), data=data)
model1c<-lmer(resp ~ 1 +(1|bk), data=data)

#test significance of each term with anova
term3<-anova(model1a,model1)
term2<-anova(model1b,model1a)
term1<-anova(model1c,model1b)
terms<-list(term1,term2,term3)

#loop thorugh each term and save the important info... this should be a function
    termeff<-terms[[k]]
    delAIC<-termeff[2,2]-termeff[1,2]
    Chisq<-termeff[2,5]
    ChisqDF<-termeff[2,6]
    pval<-termeff[2,7]
    respname<-paste(respnames[i])
    termname<-paste('term',k)
    termeffrow<-c(respname,termname,delAIC,Chisq,ChisqDF,pval)
    termeffs1<-rbind(termeffs1,termeffrow)
  
#Model2
#fit mixed effects model, and reduced models
  model2<-lmer(resp ~ mvtrt + logtotal + mvtrt:logtotal + I(logtotal^2) +(1|bk), data=data)
  models2[[i]]<-model2
  model2a<-lmer(resp ~ mvtrt + logtotal + mvtrt:logtotal +(1|bk), data=data)
  model2b<-lmer(resp ~ mvtrt + logtotal +(1|bk), data=data)
  model2c<-lmer(resp ~ mvtrt +(1|bk), data=data)
  model2d<-lmer(resp ~ 1 +(1|bk), data=data)

#test significance of each term with anova
term4<-anova(model2a,model2)
  term3<-anova(model2b,model2a)
  term2<-anova(model2c,model2b)
  term1<-anova(model2d,model2c)
  terms<-list(term1,term2,term3,term4)

#loop thorugh each term and save the important info... this should be a function
    termeff<-terms[[k]]
    delAIC<-termeff[2,2]-termeff[1,2]
    Chisq<-termeff[2,5]
    ChisqDF<-termeff[2,6]
    pval<-termeff[2,7]
    respname<-paste(respnames[i])
    termname<-paste('term',k)
    termeffrow<-c(respname, termname,delAIC,Chisq,ChisqDF,pval)
    termeffs2<-rbind(termeffs2,termeffrow)

colnames(termeffs1)<-c('resp','term','delAIC','Chisq','ChisqDF','pval')
colnames(termeffs1)<-c('resp','term','delAIC','Chisq','ChisqDF','pval')
#write.table(termeffs1, file='termeffs1_mixedcomm.txt', sep='\t', row.names=F, col.names=T)
#write.table(termeffs2, file='termeffs2_mixedcomm.txt', sep='\t', row.names=F, col.names=T)

#loop through each model, models ... translate as above in monoculture pots.. this should be a function
  logLik<-summary(models[[i]])@logLik
  logLikrow<-c(respnames[i],NA,NA,logLik)
  REmat<-summary(models[[i]])@REmat
  coefs<-summary(models[[i]])@coefs
  coefmat<-cbind(rownames(coefs),coefs)
  modelfit<-rbind(logLikrow,REmat,coefmat)
  modelfits[[i]]<-modelfit
write.table(modelfits1, file='modelfits1_mixedcomm.txt', sep='\t', row.names=F, col.names=T)

```

